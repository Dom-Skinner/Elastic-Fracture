clear
nstr = '400';
xend_val = [20,30,40,50,60,70];

for l = 1:numel(xend_val)

file = strcat('n',nstr,'x',num2str(xend_val(l)));
load(file)

u = 4 - 6*s;
K = 3*sqrt(2*pi)*KI;
p1 = polyfit(K(end-1:end).^u,lambda(end-1:end),1);
l0 = p1(2);
D_save(l) = p1(1);

z = tan((0.5:1:n-1.5)*atan(sqrt(xmax))/(n-1)).^2;

[~ ,h0_prime_LEFM] = interpolate_hprime(x,n,hprime_data,K,0.5);

h0_prime_LEFM_23 = convert(0.5,2/3,n,t,x,h0_prime_LEFM);
h_coefficient_matrix_23 = hprime_to_h_s(x,2/3);
h0_LEFM_23 = h_integrate(h0_prime_LEFM_23,x,n,t, ... 
    h_coefficient_matrix_23,2/3);
h0_LEFM_23_z = h_integrate(h0_prime_LEFM_23,z,n-1,t, ...
    h_coefficient_matrix_23,2/3);

[~,H_LEFM_23] = linear_perturbation_solve(n,t,xmax, h0_LEFM_23,...
    h0_LEFM_23_z,l0,kernel_matrix_s,s);


er = ones(1,round(0.2*n));
for k = 20:round(0.25*n)
    p3 = polyfit(x(k:k+3) , H_LEFM_23(k:k+3)'.*x(k:k+3).^(-s),1);
    p4 = polyfit(x(k:k+4) ,H_LEFM_23(k:k+4)'.*x(k:k+4).^(-s) ,2);
    er(k) = abs(p3(2)-p4(3));
end
[~,I] = min(er(:));

p3 = polyfit(x(I:I+1) ,H_LEFM_23(I:I+1)'.*x(I:I+1).^(-s), 1);
l0_save(l) = l0;
l1_save(l) = -3*l0/p3(2);
clearvars -except l0_save l1_save D_save xend_val nstr
end

figure('units','normalized','outerposition',[0 0 0.5 1])
plot(xend_val,l0,'o-')

ax = gca;
axis square
xlabel(ax,'$ x_{end} $','Interpreter','latex','fontsize',25);
ylabel(ax,'$ \lambda_0$','Interpreter','latex','fontsize',25);
title(ax,'Linear perturbation problem estimates of $\tilde{H}\xi^{-s}$',...
    'fontsize', 25,'Interpreter','latex');
set(ax,'TickLabelInterpreter', 'latex');
set(ax,'fontsize',20')
legend({'$H_0$ interpolated','$H_0$ with LEFM correction',...
    '$H_0$ with LEFM correction and $2/3$ integration'...
    },'Interpreter','Latex'...
    ,'fontsize',20,'Location','southeast')


%fprintf('\n\n xend = %.3e%%\n',xend)
%fprintf('l0 = %.3e%%\n',l0)
%fprintf('l1 = %.3e%%\n',-3*l0/p3(2))
